<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>horse-money</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft YaHei", sans-serif;
            background: #e8eaf0;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 24px;
            max-width: 500px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #555;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 500;
        }
        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .input-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"]:focus {
            outline: none;
            border-color: #5a6a7a;
        }
        .button-row {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-user-select: none;
            user-select: none;
        }
        .btn-calculate {
            background: #5a6a7a;
            color: white;
        }
        .btn-calculate:active {
            background: #4a5a6a;
        }
        .btn-calculate:hover {
            background: #6a7a8a;
        }
        .btn-ratio {
            background: #7a6a5a;
            color: white;
        }
        .btn-ratio:active {
            background: #6a5a4a;
        }
        .btn-ratio:hover {
            background: #8a7a6a;
        }
        .result-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        .result-item {
            margin-bottom: 15px;
        }
        .result-item:last-child {
            margin-bottom: 0;
        }
        .result-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .result-value {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            word-break: break-all;
        }
        .result-value.target {
            color: #5a7a6a;
        }
        .result-value.buy {
            color: #5a6a8a;
        }
        .result-value.stop {
            color: #8a5a5a;
        }
        .result-value.ratio {
            color: #7a5a8a;
        }
        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>horse-money</h1>
        
        <div class="row">
            <div class="input-group">
                <label>颈线位</label>
                <input type="number" id="neckline" step="0.01" placeholder="请输入颈线位">
            </div>
            <div class="input-group">
                <label>头部价格</label>
                <input type="number" id="headPrice" step="0.01" placeholder="请输入头部价格">
            </div>
        </div>

        <div class="row">
            <div class="input-group">
                <label>收益比</label>
                <input type="number" id="ratioInput" step="0.1" placeholder="默认15" value="15">
            </div>
            <div class="input-group">
                <label>&nbsp;</label>
                <button class="btn-ratio" id="ratioBtn" onclick="setRatio15()">按收益比计算</button>
            </div>
        </div>

        <div class="button-row">
            <button class="btn-calculate" id="calculateBtn" onclick="calculate()">计算</button>
        </div>

        <div class="result-section">
            <div class="result-item">
                <div class="result-label">目标价格</div>
                <div class="result-value target" id="targetPrice">--</div>
            </div>
            <div class="divider"></div>
            <div class="result-item">
                <div class="result-label">买入价格</div>
                <div class="result-value buy" id="buyPrice">--</div>
            </div>
            <div class="result-item">
                <div class="result-label">止损价格</div>
                <div class="result-value stop" id="stopPrice">--</div>
            </div>
            <div class="divider"></div>
            <div class="result-item">
                <div class="result-label">收益比</div>
                <div class="result-value ratio" id="ratio">--</div>
            </div>
        </div>
    </div>

    <script>
        // 保存数据到本地存储
        function saveData(data) {
            try {
                localStorage.setItem('horseMoneyData', JSON.stringify(data));
            } catch (e) {
                console.log('保存数据失败：' + e.message);
            }
        }

        // 从本地存储加载数据
        function loadData() {
            try {
                var data = localStorage.getItem('horseMoneyData');
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.log('加载数据失败：' + e.message);
                return null;
            }
        }

        // 暴露到全局作用域
        window.calculate = function() {
            try {
                var neckline = parseFloat(document.getElementById('neckline').value);
                var headPrice = parseFloat(document.getElementById('headPrice').value);
                var customRatio = parseFloat(document.getElementById('ratioInput').value) || 15;

                if (isNaN(neckline) || isNaN(headPrice)) {
                    alert('请输入有效的颈线位和头部价格！');
                    return;
                }

                // 目标价格 = 颈线位 + 颈线位 - 头部价格
                var targetPrice = neckline + neckline - headPrice;
                // 买入价格 = 颈线位 * 1.03
                var buyPrice = neckline * 1.03;
                // 止损价格 = 颈线位
                var stopPrice = neckline;
                // 收益比 = (目标价 - 止损价) ÷ (买入价 - 止损价)
                var ratio = (targetPrice - stopPrice) / (buyPrice - stopPrice);

                document.getElementById('targetPrice').textContent = targetPrice.toFixed(3);
                document.getElementById('buyPrice').textContent = buyPrice.toFixed(3);
                document.getElementById('stopPrice').textContent = stopPrice.toFixed(3);
                document.getElementById('ratio').textContent = ratio.toFixed(3);

                // 保存数据
                saveData({
                    neckline: neckline,
                    headPrice: headPrice,
                    targetPrice: targetPrice,
                    buyPrice: buyPrice,
                    stopPrice: stopPrice,
                    ratio: ratio,
                    customRatio: customRatio
                });
            } catch (e) {
                alert('计算出错：' + e.message);
            }
        };

        window.setRatio15 = function() {
            try {
                var neckline = parseFloat(document.getElementById('neckline').value);
                var headPrice = parseFloat(document.getElementById('headPrice').value);
                var customRatio = parseFloat(document.getElementById('ratioInput').value) || 15;

                if (isNaN(neckline) || isNaN(headPrice)) {
                    alert('请输入有效的颈线位和头部价格！');
                    return;
                }

                // 目标价格 = 颈线位 + 颈线位 - 头部价格
                var targetPrice = neckline + neckline - headPrice;
                // 止损价格 = 颈线位
                var stopPrice = neckline;
                // 根据自定义收益比反推买入价格
                // R = (目标价 - 止损价) ÷ (买入价 - 止损价)
                // R * (买入价 - 止损价) = 目标价 - 止损价
                // R * 买入价 - R * 止损价 = 目标价 - 止损价
                // R * 买入价 = 目标价 - 止损价 + R * 止损价
                // R * 买入价 = 目标价 + (R - 1) * 止损价
                // 买入价 = (目标价 + (R - 1) * 止损价) / R
                var buyPrice = (targetPrice + (customRatio - 1) * stopPrice) / customRatio;

                document.getElementById('targetPrice').textContent = targetPrice.toFixed(3);
                document.getElementById('buyPrice').textContent = buyPrice.toFixed(3);
                document.getElementById('stopPrice').textContent = stopPrice.toFixed(3);
                document.getElementById('ratio').textContent = customRatio.toFixed(3);

                // 保存数据
                saveData({
                    neckline: neckline,
                    headPrice: headPrice,
                    targetPrice: targetPrice,
                    buyPrice: buyPrice,
                    stopPrice: stopPrice,
                    ratio: customRatio,
                    customRatio: customRatio
                });
            } catch (e) {
                alert('计算出错：' + e.message);
            }
        };

        // 页面加载完成后恢复数据
        window.addEventListener('load', function() {
            var calculateBtn = document.getElementById('calculateBtn');
            var ratioBtn = document.getElementById('ratioBtn');

            if (calculateBtn) {
                if (calculateBtn.addEventListener) {
                    calculateBtn.addEventListener('click', window.calculate);
                } else if (calculateBtn.attachEvent) {
                    calculateBtn.attachEvent('onclick', window.calculate);
                }
            }

            if (ratioBtn) {
                if (ratioBtn.addEventListener) {
                    ratioBtn.addEventListener('click', window.setRatio15);
                } else if (ratioBtn.attachEvent) {
                    ratioBtn.attachEvent('onclick', window.setRatio15);
                }
            }

            // 恢复上次的数据
            var savedData = loadData();
            if (savedData) {
                document.getElementById('neckline').value = savedData.neckline || '';
                document.getElementById('headPrice').value = savedData.headPrice || '';
                document.getElementById('ratioInput').value = savedData.customRatio || 15;
                document.getElementById('targetPrice').textContent = savedData.targetPrice ? savedData.targetPrice.toFixed(3) : '--';
                document.getElementById('buyPrice').textContent = savedData.buyPrice ? savedData.buyPrice.toFixed(3) : '--';
                document.getElementById('stopPrice').textContent = savedData.stopPrice ? savedData.stopPrice.toFixed(3) : '--';
                document.getElementById('ratio').textContent = savedData.ratio ? savedData.ratio.toFixed(3) : '--';
            }
            if (savedData) {
                document.getElementById('neckline').value = savedData.neckline || '';
                document.getElementById('headPrice').value = savedData.headPrice || '';
                document.getElementById('ratioInput').value = savedData.customRatio || 15;
                document.getElementById('targetPrice').textContent = savedData.targetPrice ? savedData.targetPrice.toFixed(3) : '--';
                document.getElementById('buyPrice').textContent = savedData.buyPrice ? savedData.buyPrice.toFixed(3) : '--';
                document.getElementById('stopPrice').textContent = savedData.stopPrice ? savedData.stopPrice.toFixed(3) : '--';
                document.getElementById('ratio').textContent = savedData.ratio ? savedData.ratio.toFixed(3) : '--';
            }

            console.log('页面加载完成');
        });
    </script>
</body>
</html>
